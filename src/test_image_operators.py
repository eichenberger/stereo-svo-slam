import image_operators as imo
import numpy as np
import math
from math import cos, sin

def _rot_mat_x(angle):
    return np.mat([[1, 0, 0],
                    [0, cos(angle), -sin(angle)],
                    [0, sin(angle), cos(angle)]])

def _rot_mat_y(angle):
    return np.mat([[cos(angle), 0, sin(angle)],
                    [0, 1, 0],
                    [-sin(angle), 0, cos(angle)]])

def _rot_mat_z(angle):
    return np.mat([[cos(angle), -sin(angle), 0],
                    [sin(angle), cos(angle), 0],
                    [0, 0, 1]])

def rotation_matrix(angle):
    rot_x = _rot_mat_x(angle[0])
    rot_y = _rot_mat_y(angle[1])
    rot_z = _rot_mat_z(angle[2])

    rot = np.matmul(rot_x, rot_y)
    rot = np.matmul(rot, rot_z)

    return rot

def transform_keypoints(pose, keypoints3d, fx, fy, cx, cy):
    extrinsic = np.zeros((3,4))
    extrinsic[:,0:3] = rotation_matrix(pose[3:])
    extrinsic[:,3] = np.transpose(pose[0:3])

    kps3d = np.ones((4, keypoints3d.shape[1]))
    kps3d[0:3, :] = keypoints3d

    kps2d = np.matmul(extrinsic, kps3d)
    kps2d = (kps2d*[[fx],[fy],[1]])/kps2d[2,:] + [[cx],[cy],[0]]
    return kps2d[0:2,:]

print(imo.rotation_matrix(np.array([0.0, 0.0, 0.0])))
print(imo.rotation_matrix(np.array([math.pi/4, 0.0, 0.0])))
print(imo.rotation_matrix(np.array([0.0, math.pi/4, 0.0])))
print(imo.rotation_matrix(np.array([0.0, 0.0, math.pi])))

pose = np.array([1.0,2,3.0,0.0,0.0,0.0])
kps = np.array([[1.0,3.0],[2.0,4.0],[3.0,5.0]])
fx = 1.0
fy = 1.0
cx = 0.0
cy = 0.0

kps2d = imo.transform_keypoints(pose, kps, fx, fy, cx, cy)
kps2d_verify = transform_keypoints(pose, kps, fx, fy, cx, cy)
diff = kps2d - kps2d_verify
print(f"kps2d: {kps2d}")
print(f"kps2d_verify: {kps2d_verify}")
print(f"diff: {diff}")

fx = 743
fy = 743
cx = 365
cy = 238

kps = np.array([[-4.25630576e-01, -2.06632011e+00, -1.89412676e+00,
        -1.36908812e+00, -1.39982614e+00, -1.58555975e+00,
        -2.02040188e+00, -1.91527332e+00, -1.03316005e+00,
        -2.30396706e+00, -2.59196294e+00, -1.12983000e+00,
        -2.83881655e+00, -8.05502329e-01, -8.10819176e-01,
        -8.47372500e-01, -4.61982138e-01, -4.12904080e-01,
        -4.14318135e-01, -9.33946161e-01, -1.51325647e+00,
        -1.87566549e+00, -1.70139106e+00, -1.89781902e+00,
        -1.72797529e+00, -1.89043451e+00, -2.79134471e+00,
        -4.15732190e-01, -6.30144837e-01, -7.26143464e-01,
        -1.75455953e+00, -8.52429284e-01, -2.01043279e+00,
        -2.02704794e+00, -2.06027824e+00, -2.07689338e+00,
        -2.09350853e+00, -1.67480682e+00, -1.83874294e+00,
        -1.40775610e+00, -1.37150487e+00, -7.71681275e-01,
        -7.71681275e-01, -7.86450294e-01, -7.51004647e-01,
        -5.15642495e-01, -2.28814311e+00, -1.98432328e+00,
        -1.57843897e+00, -1.68050345e+00, -1.61997684e+00,
        -1.60336169e+00, -1.66982228e+00, -1.55707664e+00,
        -1.77544714e+00, -1.73746966e+00, -7.49527745e-01,
        -7.56912255e-01, -7.64296765e-01, -7.38450980e-01,
        -7.38450980e-01, -1.77544714e+00, -1.82291899e+00,
        -3.40121834e-01, -1.31971739e+00, -1.43364983e+00,
        -1.39567235e+00, -1.43364983e+00, -1.39567235e+00,
        -1.53808790e+00, -1.32921176e+00, -2.19474501e-01,
        -1.18679622e+00, -2.74823514e-01, -4.23249009e-01,
        -1.18679622e+00, -4.95131382e-01, -2.32612059e-01,
        -9.96908824e-01, -1.36718924e+00, -1.09185252e+00,
        -1.01589756e+00, -7.97527059e-01, -1.00640319e+00,
        -9.96908824e-01, -1.02539193e+00, -1.02539193e+00,
        -9.30448235e-01, -3.16478992e-01, -3.65533235e-01,
        -4.47501294e-01, -3.72179294e-01, -2.85780529e-01,
        -2.82457500e-01, -1.51303892e-01, -2.80611373e-01,
        -3.41797311e-01, -2.75336723e-01, -4.27246639e-01,
        -6.55111513e-01, -2.65842353e-01, -1.70898655e-01,
        -1.47162731e-01, -3.03819832e-01, -2.84831092e-01,
        -1.99381765e-01, -3.47640000e-01, -5.79156555e-01,
        -2.39258118e-01, -1.00397910e-01, -5.37340926e-02,
        -6.64605882e-02, -1.23426807e-01, -2.61814439e-02,
        -1.32921176e-01, -2.37359244e-01, -1.03844669e-01,
         4.15378676e-03, -3.79774790e-02, -5.22190336e-02,
        -5.22190336e-02,  9.96908824e-02, -2.18370504e-01,
        -2.90765074e-02,  3.98763529e-02,  5.38014286e-02,
         1.07194497e-02, -1.97967710e-02,  4.84212857e-01,
         9.71347059e-02,  1.89887395e-01,  1.32921176e-01,
         3.98763529e-02,  1.80393025e-01,  1.80393025e-01,
         2.32612059e-01,  2.32612059e-01,  2.43688824e-01,
         1.29598147e-01,  9.82460870e-02,  9.24669054e-02,
         8.03065441e-02,  7.47681618e-02,  7.70942824e-02,
         1.00640319e+00,  5.42761471e-01,  1.01589756e+00,
         9.58931345e-01,  9.01965126e-01,  1.01589756e+00,
         7.69043950e-01,  4.22931016e-01,  3.98763529e-01,
         3.92721658e-01,  7.47681618e-01,  3.51850173e-01,
         2.07957324e-01,  1.79242193e-01,  1.99381765e-01,
         1.18780626e-01,  1.43364983e+00,  1.38617798e+00,
         1.26275118e+00,  1.25444360e+00,  1.07286378e+00,
         1.03488630e+00,  1.13932437e+00,  1.10134689e+00,
         7.86450294e-01,  9.18364492e-01,  6.92297794e-01,
         8.39820160e-01,  9.18364492e-01,  1.44314420e+00,
         2.59800481e-01,  1.23426807e+00,  1.68050345e+00,
         1.72797529e+00,  1.27936632e+00,  1.27936632e+00,
         1.68999782e+00,  1.68999782e+00,  1.61404286e+00,
         8.72849059e-01,  9.84825080e-01,  9.66699465e-01,
         9.48573850e-01,  9.42531979e-01,  7.05220686e-01,
         6.54636794e-01,  6.44667706e-01,  6.38021647e-01,
         2.20269378e+00,  8.43000093e-01,  7.87557971e-01,
         7.74265853e-01,  7.67619794e-01,  7.57650706e-01,
         7.47681618e-01,  7.31066471e-01,  7.17774353e-01,
         7.11128294e-01,  6.91190118e-01,  6.84544059e-01,
         6.64605882e-01,  6.64605882e-01,  6.61282853e-01,
         6.39683162e-01,  1.90077282e+00,  8.10819176e-01,
         1.02818439e+00,  5.50376746e-01,  5.02944992e-01,
         4.10847273e-01,  4.53295294e-01,  1.20515200e+00,
         9.08294706e-01,  8.89305966e-01,  9.08294706e-01,
         9.01965126e-01,  8.92470756e-01,  8.73482017e-01,
         8.70317227e-01,  8.54493277e-01,  1.75012882e+00,
         1.01589756e+00,  1.01273277e+00,  1.00007361e+00,
         9.84249664e-01,  9.68425714e-01,  9.55766555e-01,
         9.55766555e-01,  9.33613025e-01,  9.27283445e-01,
         9.14624286e-01,  9.14624286e-01,  5.10697152e-01,
         6.72913456e-01,  5.25038647e-01,  1.22582863e+00,
         3.17111950e+00,  1.08451596e+00,  9.91370441e-01,
         1.77544714e+00,  1.10566251e+00,  4.82192778e-01,
         9.67666165e-01,  2.00489441e+00,  6.93682390e-01,
         5.98145294e-01,  1.68050345e+00,  3.45595059e+00,
         2.94918860e+00,  3.52241118e+00,  3.45595059e+00,
         3.49392807e+00],
       [-2.61600188e-01, -9.42531979e-01, -8.36295735e-01,
        -4.51932000e-01, -4.07071103e-01, -2.46853613e-01,
        -2.39258118e-01,  0.00000000e+00,  1.11774626e-01,
         5.09531176e-01,  5.89837721e-01,  3.82148382e-01,
         1.21527933e+00,  4.73199388e-01,  4.94466776e-01,
         5.89837721e-01, -3.01504132e-01, -2.53115857e-01,
        -2.10694205e-01, -3.70780124e-01, -4.65224118e-01,
        -3.39687451e-01, -1.86089647e-01, -1.03383137e-01,
         1.19629059e-01,  3.54456471e-01,  7.88032689e-01,
         1.66858498e-01,  3.71686993e-01,  4.08609542e-01,
         1.30927359e+00,  6.09703657e-01, -1.68643743e+00,
        -1.50367081e+00, -1.07167699e+00, -8.30757353e-01,
        -6.47990735e-01, -3.58887176e-01, -1.25536667e-01,
        -6.64605882e-02,  9.06280749e-02,  2.54765588e-01,
         2.62150098e-01,  3.87686765e-01,  4.51932000e-01,
         3.82721318e-01,  1.97482891e+00,  2.00331202e+00,
        -1.53690110e+00, -1.65202034e+00, -1.10490728e+00,
        -1.03844669e+00, -7.31066471e-01, -4.36741008e-01,
        -1.70898655e-01, -1.13932437e-01,  1.25536667e-01,
         1.77228235e-01,  3.24918431e-01,  4.61531863e-01,
         4.68916373e-01,  1.58555975e+00,  1.93685143e+00,
         4.53495779e-01, -1.78494151e+00, -1.50011042e+00,
        -1.35769487e+00, -1.00640319e+00, -7.12077731e-01,
        -6.36122773e-01, -3.13314202e-01, -1.08191655e-02,
         1.61404286e-01,  7.72379809e-02,  2.55348576e-01,
         9.96908824e-01,  4.55255029e-01,  2.71884225e-01,
         1.54336255e+00,  2.05078387e+00, -1.89887395e+00,
        -1.70898655e+00, -1.46213294e+00, -1.08235815e+00,
        -7.02583361e-01, -4.27246639e-01, -3.98763529e-01,
        -1.13932437e-01,  4.74718487e-02,  2.06766275e-01,
         3.32302941e-01,  4.56362706e-01,  4.81839265e-01,
         5.21715618e-01,  2.81396959e-01,  8.19680588e-01,
        -1.97482891e+00, -1.52859353e+00, -1.38617798e+00,
        -1.01589756e+00, -3.11534007e-01, -1.23426807e-01,
        -9.49436975e-02,  3.79774790e-02,  2.84831092e-01,
         1.62828441e-01,  3.62977059e-01,  9.58931345e-01,
         4.98454412e-01,  2.55943967e-01,  2.94123454e-01,
         3.29413350e-01, -1.79443588e+00, -3.26261070e-01,
        -1.39567235e+00, -1.19629059e+00, -2.99072647e-01,
        -2.82457500e-01, -3.98763529e-01,  3.08567017e-02,
         3.56038866e-02,  2.92426588e-01,  7.59549580e-01,
         2.51304099e-01,  5.01777441e-01,  4.93707227e-01,
         4.39497438e-01,  3.18162390e-01, -1.99381765e+00,
        -8.02639412e-01, -1.35769487e+00, -2.88759797e-01,
        -1.19629059e-01, -4.27246639e-01, -3.98763529e-01,
         8.63987647e-02,  9.96908824e-02,  2.65842353e-01,
         3.19010824e-01,  3.61198849e-01,  3.87205166e-01,
         4.48608971e-01,  5.12300368e-01,  6.03462141e-01,
        -1.85140210e+00, -1.00244721e+00, -1.22477370e+00,
        -1.14881874e+00, -8.16515798e-01, -4.65224118e-01,
        -3.60786050e-01,  7.85443316e-02,  2.29591123e-01,
         2.71884225e-01,  5.89837721e-01,  3.98763529e-01,
         2.98000702e-01,  3.46400642e-01,  4.90785882e-01,
         3.20990501e-01, -1.74696403e+00, -1.64252597e+00,
        -1.06336941e+00, -9.13833088e-01, -7.78538319e-01,
        -6.36122773e-01, -3.32302941e-01,  0.00000000e+00,
         8.30757353e-02,  4.16889144e-01,  4.20917059e-01,
         6.70647754e-01,  7.91485187e-01,  1.69949218e+00,
         4.20917059e-01,  2.03179513e+00, -1.99381765e+00,
        -1.66151471e+00, -1.06336941e+00, -1.02183154e+00,
        -8.54493277e-01, -6.55111513e-01, -1.61404286e-01,
         2.21535294e-02,  1.75214278e-01,  3.50428556e-01,
         5.37726578e-01,  5.98145294e-01,  5.24300196e-01,
         5.94822265e-01,  6.77898000e-01,  7.24420412e-01,
        -1.75645840e+00, -6.05141146e-01, -4.31993824e-01,
        -3.55564147e-01, -2.82457500e-01, -2.19319941e-01,
        -1.36244206e-01, -9.96908824e-03,  8.30757353e-02,
         1.52859353e-01,  2.99072647e-01,  3.62210206e-01,
         5.08423500e-01,  5.15069559e-01,  6.08114382e-01,
         6.20298824e-01, -1.24281300e+00, -5.81530147e-01,
        -5.27775260e-01, -2.20150699e-01, -1.31124944e-01,
        -9.36490107e-02, -6.30523529e-02,  4.43070588e-03,
         7.59549580e-02,  1.67733866e-01,  3.06984622e-01,
         3.70280420e-01,  4.39905798e-01,  5.66497395e-01,
         5.88650924e-01,  7.05748151e-01, -1.10213809e+00,
        -4.93707227e-01, -4.74718487e-01, -3.82939580e-01,
        -2.62677563e-01, -1.42415546e-01, -5.06366387e-02,
        -4.11422689e-02,  1.29756387e-01,  1.61404286e-01,
         2.75336723e-01,  3.13314202e-01,  2.55348576e-01,
         3.75917702e-01,  3.20672338e-01,  8.67679902e-01,
        -1.98432328e+00, -5.49810321e-01, -4.23686250e-01,
        -5.17443151e-01, -2.32612059e-01, -6.36324781e-02,
        -7.44358588e-02,  4.43070588e-02,  3.32302941e-02,
         9.96908824e-02,  4.31993824e-01,  1.15831311e+00,
         1.25444360e+00,  1.55707664e+00,  1.84190773e+00,
         2.02230076e+00],
       [ 9.61557447e-01,  4.10847273e+00,  3.76610000e+00,
         3.01288000e+00,  2.82457500e+00,  3.22808571e+00,
         4.51932000e+00,  4.10847273e+00,  2.05423636e+00,
         5.02146667e+00,  5.64915000e+00,  2.25966000e+00,
         6.45617143e+00,  1.80772800e+00,  1.80772800e+00,
         1.88305000e+00,  1.10227317e+00,  9.61557447e-01,
         9.61557447e-01,  2.37858947e+00,  3.47640000e+00,
         5.02146667e+00,  4.51932000e+00,  5.02146667e+00,
         4.51932000e+00,  5.02146667e+00,  6.45617143e+00,
         9.61557447e-01,  1.67382222e+00,  1.67382222e+00,
         4.51932000e+00,  1.96492174e+00,  5.64915000e+00,
         5.64915000e+00,  5.64915000e+00,  5.64915000e+00,
         5.64915000e+00,  4.51932000e+00,  5.02146667e+00,
         4.10847273e+00,  4.10847273e+00,  2.51073333e+00,
         2.51073333e+00,  2.51073333e+00,  2.25966000e+00,
         1.55838621e+00,  6.45617143e+00,  6.45617143e+00,
         5.64915000e+00,  6.45617143e+00,  5.64915000e+00,
         5.64915000e+00,  5.64915000e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  2.51073333e+00,
         2.51073333e+00,  2.51073333e+00,  2.51073333e+00,
         2.51073333e+00,  6.45617143e+00,  6.45617143e+00,
         1.32921176e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  1.05100465e+00,
         6.45617143e+00,  1.22143784e+00,  2.37858947e+00,
         6.45617143e+00,  2.25966000e+00,  1.02711818e+00,
         5.02146667e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  2.15205714e+00,  2.51073333e+00,
         3.01288000e+00,  3.01288000e+00,  2.25966000e+00,
         2.25966000e+00,  9.61557447e-01,  2.51073333e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  2.82457500e+00,  1.61404286e+00,
         1.61404286e+00,  6.45617143e+00,  6.45617143e+00,
         2.25966000e+00,  3.47640000e+00,  6.45617143e+00,
         2.25966000e+00,  9.61557447e-01,  9.61557447e-01,
         9.82460870e-01,  6.45617143e+00,  1.36949091e+00,
         6.45617143e+00,  6.45617143e+00,  2.82457500e+00,
         2.82457500e+00,  6.45617143e+00,  1.61404286e+00,
         1.61404286e+00,  4.51932000e+00,  6.45617143e+00,
         1.41228750e+00,  2.25966000e+00,  2.15205714e+00,
         1.45784516e+00,  9.61557447e-01,  6.45617143e+00,
         3.47640000e+00,  6.45617143e+00,  1.55838621e+00,
         1.00429333e+00,  6.45617143e+00,  6.45617143e+00,
         4.51932000e+00,  4.51932000e+00,  3.01288000e+00,
         2.25966000e+00,  1.96492174e+00,  1.96492174e+00,
         1.88305000e+00,  1.88305000e+00,  1.80772800e+00,
         6.45617143e+00,  3.76610000e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  4.10847273e+00,  4.10847273e+00,
         4.10847273e+00,  5.64915000e+00,  2.65842353e+00,
         1.45784516e+00,  1.36949091e+00,  1.73820000e+00,
         9.61557447e-01,  6.45617143e+00,  6.45617143e+00,
         5.64915000e+00,  5.64915000e+00,  6.45617143e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         3.76610000e+00,  4.10847273e+00,  3.76610000e+00,
         4.10847273e+00,  4.10847273e+00,  6.45617143e+00,
         1.36949091e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00,  5.64915000e+00,  5.64915000e+00,
         6.45617143e+00,  6.45617143e+00,  6.45617143e+00,
         3.01288000e+00,  4.10847273e+00,  4.10847273e+00,
         4.10847273e+00,  4.10847273e+00,  2.51073333e+00,
         2.25966000e+00,  2.25966000e+00,  2.25966000e+00,
         6.45617143e+00,  2.37858947e+00,  2.25966000e+00,
         2.25966000e+00,  2.25966000e+00,  2.25966000e+00,
         2.25966000e+00,  2.25966000e+00,  2.25966000e+00,
         2.25966000e+00,  2.25966000e+00,  2.25966000e+00,
         2.25966000e+00,  2.25966000e+00,  2.25966000e+00,
         1.88305000e+00,  4.51932000e+00,  2.25966000e+00,
         2.65842353e+00,  1.41228750e+00,  1.22143784e+00,
         1.02711818e+00,  1.15880000e+00,  3.01288000e+00,
         2.15205714e+00,  2.15205714e+00,  2.15205714e+00,
         2.15205714e+00,  2.15205714e+00,  2.15205714e+00,
         2.15205714e+00,  2.15205714e+00,  3.76610000e+00,
         2.15205714e+00,  2.15205714e+00,  2.15205714e+00,
         2.15205714e+00,  2.15205714e+00,  2.15205714e+00,
         2.15205714e+00,  2.15205714e+00,  2.15205714e+00,
         2.15205714e+00,  2.15205714e+00,  1.18929474e+00,
         1.41228750e+00,  1.12983000e+00,  2.51073333e+00,
         6.45617143e+00,  2.05423636e+00,  1.88305000e+00,
         3.22808571e+00,  2.05423636e+00,  9.61557447e-01,
         1.80772800e+00,  3.76610000e+00,  1.41228750e+00,
         1.18929474e+00,  3.22808571e+00,  6.45617143e+00,
         5.64915000e+00,  6.45617143e+00,  6.45617143e+00,
         6.45617143e+00]])

kps2d = imo.transform_keypoints(pose, kps, fx, fy, cx, cy)
kps2d_verify = transform_keypoints(pose, kps, fx, fy, cx, cy)
diff = kps2d - kps2d_verify
print(f"kps2d: {kps2d}")
print(f"kps2d_verify: {kps2d_verify}")
print(f"diff: {diff}")


image = (100*np.random.randn(100,100)).astype(np.uint8)
image2 = (100*np.random.randn(100,100)).astype(np.uint8)

kps1 = 2.0+np.array([[1.0,2.0,3.0,4.0],[2.0,3.0,4.0,5.0]])
kps2 = 2.0+np.array([[1.0,2.0,3.0,4.0],[2.0,3.0,4.0,5.0]])

diff = imo.get_total_intensity_diff(image, image2, kps1, kps2)
diff_verify = np.empty((4))
for i in range(0,4):
    p = np.array([3+i,4+i]).astype(np.float64)
    diff_verify[i] = imo.get_intensity_diff(image, image2, p, p, 0)

print(f"Diff: {diff}")
print(f"Diff verify: {diff_verify}")
